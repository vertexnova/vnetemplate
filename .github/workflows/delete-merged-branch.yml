# Delete the source branch when a pull request is merged.
# Skips deletion for the default branch (main) and for forks (no write access).
#
# If your org disables "Read and write permissions" for GITHUB_TOKEN, add a
# PAT (repo scope) as repository secret REPO_ACCESS_TOKEN; this job will use it.

name: Delete branch on merge

on:
  pull_request:
    types: [closed]

permissions:
  contents: write

jobs:
  delete-branch:
    if: github.event.pull_request.merged == true && github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    steps:
      - name: Delete branch
        run: |
          BRANCH="${{ github.event.pull_request.head.ref }}"
          DEFAULT="${{ github.event.repository.default_branch }}"
          if [ -z "$BRANCH" ] || [ "$BRANCH" = "$DEFAULT" ]; then
            echo "Skipping delete for branch: $BRANCH"
            exit 0
          fi
          echo "Deleting branch: $BRANCH"
          REF="refs/heads/${BRANCH}"
          REF_ENC=$(echo "$REF" | sed 's/\//%2F/g')
          curl -sSf -X DELETE \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.REPO_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/git/refs/${REF_ENC}"
